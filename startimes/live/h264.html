<!DOCTYPE html>
<html lang="zh_CN">

<head>
  <meta charset="utf-8">
  <meta name="renderer" content="ie-comp">
  <title>四达时代监控平台</title>
  <link rel="stylesheet" href="static/index.css?version=1535093144136">
  <link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_265237_4z9hcbyuo4j.css?version=1535093144136">
</head>

<body>
  <div class="left">
    <div class="main">
      <div id="maxVideo" class="video"></div>
      <div class="overflow">
        <div id="bitrate" class="bitrate"></div>
        <div class="fullscreen">
          <i class="iconfont icon-quanping" onclick="fullScreen(this)"></i>
        </div>
      </div>
      <div id="loading" class="mask">
        <img src="static/loading-mask.png" class="loading-mask"/>
        <img src="static/loading-body.png" class="loading-body"/>
        <div id="info" class="mask-info">网络连接中<img src="static/loading.gif" /></div>
      </div>
    </div>
    <div class="other">
      <div class="min min-hide">
        <div id="minVideo1" class="video"></div>
        <div class="overflow">
          <div id="bitrate1" class="bitrate"></div>
        </div>
        <div id="loading1" class="mask">
          <img src="static/loading-mask.png" class="loading-mask min-loading"/>
          <img src="static/loading-body.png" class="loading-body min-loading"/>
          <div id="info1" class="mask-info min-info">网络连接中<img src="static/loading.gif" /></div>
        </div>
      </div>
      <div class="min">
        <div id="minVideo2" class="video"></div>
        <div class="overflow">
          <div id="bitrate2" class="bitrate"></div>
        </div>
        <div id="loading2" class="mask">
          <img src="static/loading-mask.png" class="loading-mask min-loading"/>
          <img src="static/loading-body.png" class="loading-body min-loading"/>
          <div id="info2" class="mask-info min-info">网络连接中<img src="static/loading.gif" /></div>
        </div>
      </div>
      <div class="min">
        <div id="minVideo3" class="video"></div>
        <div class="overflow">
          <div id="bitrate3" class="bitrate"></div>
        </div>
        <div id="loading3" class="mask">
          <img src="static/loading-mask.png" class="loading-mask min-loading"/>
          <img src="static/loading-body.png" class="loading-body min-loading"/>
          <div id="info3" class="mask-info min-info">网络连接中<img src="static/loading.gif" /></div>
        </div>
      </div>
      <div class="min">
        <div id="minVideo4" class="video"></div>
        <div class="overflow">
          <div id="bitrate4" class="bitrate"></div>
        </div>
        <div id="loading4" class="mask">
          <img src="static/loading-mask.png" class="loading-mask min-loading"/>
          <img src="static/loading-body.png" class="loading-body min-loading"/>
          <div id="info4" class="mask-info min-info">网络连接中<img src="static/loading.gif" /></div>
        </div>
      </div>
    </div>
  </div>
  <div class="right">
    <div class="header">
      <div class="date">
        <div class="date-week">
          <div id="week"></div>
          <div id="date"></div>
        </div>
        <div id="time" class="time"></div>
      </div>
    </div>
    <div id="videoTree" class="video-list">
    </div>
    <div class="control">
      <div class="controler-direction">
        <div class="outter-circle">
          <div class="direction control-btn" data-type="TILT_UP">·</div>
          <div class="direction control-btn" data-type="PAN_RIGHT">·</div>
          <div class="direction control-btn" data-type="PAN_LEFT">·</div>
          <div class="direction control-btn" data-type="TILT_DOWN">·</div>
        </div>
          <div class="inner-circle"></div>
      </div>
      <div class="controler-zoom">
        <div class="zoom control-btn" data-type="ZOOM_IN">+</div>
        <div class="zoom">缩放</div>
        <div class="zoom control-btn" data-type="ZOOM_OUT">-</div>
      </div>
      <div class="controler-setting">
        <div class="nowSpeed"><i class="iconfont icon-settings"></i><span id="speed">4</span>倍速</div>
        <ul class="controler-speed">
          <li data-speed="1">1倍速</li>
          <li data-speed="2">2倍速</li>
          <li data-speed="3">3倍速</li>
          <li data-speed="4" class="active">4倍速</li>
          <li data-speed="5">5倍速</li>
          <li data-speed="6">6倍速</li>
          <li data-speed="7">7倍速</li>
        </ul>
      </div>
    </div>
  </div>
  <script type="text/javascript" src="ckplayer/ckplayer.js?version=1535093144136"></script>
  <script src="./static/video-list.js?version=1535093144136.0.0"></script>
  <script src="static/jquery.min.js?version=1535093144136" charset="utf-8"></script>
  <script src="./static/template-web.js?version=1535093144136"></script>
  <script src="./static/utils.js?version=1535093144136"></script>
  <script id="videoTreeTpl" type="text/html">
    <ul class="country-list">
      {{each list country key}}
      {{if key==currentCuntryId}}
      <li class="country-item">
        <!-- <div class="country-name {{if key==currentCuntryId}}active{{/if}}" onClick="javascript:location.href = location.pathname + '?id={{key}}'"> -->
        <div class="country-name active no-link">
          <img class="country-flag" src="./static/country/{{country.enName}}.jpg" /> {{country.name}}
        </div>
        <ul class="camera-list">
          {{each country.list camera}}
          <li id="{{currentCuntryId}}-{{$index}}" class="camera-name {{if $index == currentIndex}}active{{/if}}" onClick="changeMaxVideo({{currentCuntryId}}, {{$index}})"><i id="status{{$index}}" class="iconfont icon-qiakoujiankongshexiangtou"></i>{{camera.name}}</li>
          {{/each}}
        </ul>
      </li>
      {{/if}}
      {{if countryShow && key!=currentCuntryId}}
        <li class="country-item">
          <div class="country-name" onClick="goto({{key}}, {{bitrate}}, {{countryShow}})">
            <img class="country-flag" src="./static/country/{{country.enName}}.jpg"/> {{country.name}}
          </div>
        </li>
      {{/if}}
      {{/each}}
    </ul>
  </script>
  <script type="text/javascript">
    var countryId = getUrlKey('id') || 1,
      videoIndex = getUrlKey('index') || 0,
      bitrate = getUrlKey('bitrate') || false,
      countryShow = getUrlKey('countryShow') || false,
      minVideoId = 1, fullId = -1, bitrateTask = null
    var currentVideoObj = videoList[countryId]
    var currentVideoList = currentVideoObj.list
    var flashvars = {
  		s: '0',//调用方式，0=普通方法（f=视频地址），1=网址形式,2=xml形式，3=swf形式(s>0时f=网址，配合a来完成对地址的组装)
      lv: '1', // 是否是直播流，=1则锁定进度栏
      p: '1', // 自动播放 0=默认暂停 1=默认播放 2=默认不加载视频
      b: '0', // 是否允许和播放器进行交互，0=允许，1是不允许
      v: '100' // 音量，取值范围0-100，该值只是设置默认音量，用户可以通过键盘操作音量大于100
    }
    //这里定义播放器的其它参数如背景色（跟flashvars中的b不同），是否支持全屏，是否支持交互
    var params={bgcolor:'#FFF',allowFullScreen:true,allowScriptAccess:'always'}
    $(document).ready(function(){
      if (currentVideoList != undefined) {
        initVideoPlayer(videoIndex)
      }
      initVideoTree(countryId, videoIndex)
      getCameraStatus(countryId)
      getWeek()
      getDate()
      getTime()
      setInterval(getTime, 10000)
      setInterval(getCameraStatus, 10000)

      $('.control-btn').on('mousedown', function(){
        controlPost('/start/', $(this).attr('data-type'), function(res) {
          console.log('start', res)
        })
      })
      $('.control-btn').on('mouseup', function(){
        var _this = this
        controlPost('/stop/', $(_this).attr('data-type'), function(res) {
          console.log('stop', res)
        })
      })
      $('.controler-speed > li').on('click', function() {
        var _this = this
        $(this).addClass('active')
        $('#speed').text($(this).attr('data-speed'))
        $('.controler-speed > li').each(function(){
          if(this != _this) {
            $(this).removeClass('active')
          }
        })
      })
    })
    // 初始化视频
    function initVideoPlayer(currentIndex) {
      videoIndex = currentIndex
      for (var i = 0; i < currentVideoList.length; i++) {
        var videoObj = currentVideoList[i]
        var $minVideoDiv = $('#minVideo' + minVideoId)
        $('#loading').show()
        $('#info').html('网络连接中<img src="static/loading.gif" />')
        if (i == currentIndex) {
          var $videoDiv = $('#maxVideo')
          $minVideoDiv.parent().addClass('min-hide')
          flashvars.f = videoObj.rtmp
          flashvars.wh = $videoDiv.width() + ':' + $videoDiv.height()
          flashvars.loaded = 'loadedHandler' //当播放器加载完成后发送该js函数loaded
          CKobject.embed('ckplayer/ckplayer.swf', 'maxVideo', 'ckplayer_maxVideo', '100%', '100%', false, flashvars, params)
          $videoDiv.attr('url', videoObj.rtmp)
        } else {
          $minVideoDiv.parent().removeClass('min-hide')
        }
        $('#loading' + minVideoId).show()
        $('#info' + minVideoId).html('网络连接中<img src="static/loading.gif" />')
        flashvars.f = videoObj.low
        flashvars.wh = $minVideoDiv.width() + ':' + $minVideoDiv.height()
        flashvars.loaded = 'loadedHandler' + minVideoId //当播放器加载完成后发送该js函数loaded
        CKobject.embed('ckplayer/ckplayer.swf', 'minVideo' + minVideoId, 'ckplayer_minVideo' + minVideoId, '100%', '100%', false, flashvars, params)
        $minVideoDiv.attr('url', videoObj.low)
        minVideoId++
      }
      minVideoId = 1
    }
    // 更换大的视频
    function changeMaxVideo(currentCuntryId, currentIndex){
      videoIndex = currentIndex
      var link = location.pathname + '?id=' + currentCuntryId + '&index=' + currentIndex
      if (bitrate){
         link += '&bitrate=' + bitrate
      }
      if (countryShow){
         link += '&countryShow=' + countryShow
      }
      window.history.pushState({}, 0, link)
      $('#loading').show()
      $('#info').html('网络连接中<img src="static/loading.gif" />')
      for (var i = 0; i < 4; i++) {
        var videoObj = currentVideoList[i]
        var $minVideoDiv = $('#minVideo' + minVideoId)
        if (i == currentIndex) {
          var $videoDiv = $('#maxVideo')
          $minVideoDiv.parent().addClass('min-hide')
          flashvars.f = videoObj.rtmp
          flashvars.wh = $videoDiv.width() + ':' + $videoDiv.height()
          flashvars.loaded = 'loadedHandler' //当播放器加载完成后发送该js函数loaded
          CKobject.embed('ckplayer/ckplayer.swf', 'maxVideo', 'ckplayer_maxVideo', '100%', '100%', false, flashvars, params)
          $videoDiv.attr('url', videoObj.rtmp)
        } else {
          $minVideoDiv.parent().removeClass('min-hide')
        }
        minVideoId++
      }
      minVideoId = 1
      initVideoTree(currentCuntryId, currentIndex)
    }
    // 初始化左侧树
    function initVideoTree(currentCuntryId, currentIndex) {
       if (currentCuntryId == '99') {
         $.get('http://' + baseURL + ':8083/startShell/' + currentIndex + '/')
       }
       var link = location.pathname + '?id=' + currentCuntryId + '&index=' + currentIndex + '&bitrate=' + bitrate
       var link = location.pathname + '?id=' + currentCuntryId + '&index=' + currentIndex
       if (bitrate){
          link += '&bitrate=' + bitrate
       }
       if (countryShow){
          link += '&countryShow=' + countryShow
       }
       window.history.pushState({}, 0, link)
       $('#videoTree').html(template('videoTreeTpl', {
        list: videoList,
        currentCuntryId: currentCuntryId,
        currentIndex: currentIndex,
        bitrate: bitrate,
        countryShow: countryShow
      }))
      getCameraStatus(countryId)
    }
    // 加载完成后执行
    function loadedHandler() {
      // CKobject.getObjectById('ckplayer_maxVideo').addListener('fullScreen', 'fullScreenHandler')
      CKobject.getObjectById('ckplayer_maxVideo').addListener('netStatus','videoHandler')
    }

    // 加载完成后执行
    function loadedHandler1() {
      // CKobject.getObjectById('ckplayer_minVideo1').addListener('fullScreen', 'fullScreenHandler1')
      CKobject.getObjectById('ckplayer_minVideo1').addListener('netStatus','videoHandler1')
    }
    // 加载完成后执行
    function loadedHandler2() {
      // CKobject.getObjectById('ckplayer_minVideo2').addListener('fullScreen', 'fullScreenHandler2')
      CKobject.getObjectById('ckplayer_minVideo2').addListener('netStatus','videoHandler2')
    }
    // 加载完成后执行
    function loadedHandler3() {
      // CKobject.getObjectById('ckplayer_minVideo3').addListener('fullScreen', 'fullScreenHandler3')
      CKobject.getObjectById('ckplayer_minVideo3').addListener('netStatus','videoHandler3')
    }
    // 加载完成后执行
    function loadedHandler4() {
      // CKobject.getObjectById('ckplayer_minVideo4').addListener('fullScreen', 'fullScreenHandler4')
      CKobject.getObjectById('ckplayer_minVideo4').addListener('netStatus','videoHandler4')
    }
    // 监听视频流
    function videoHandler(s){
      handlerVideoStatus(s, '')
  	}
    // 监听视频流
    function videoHandler1(s){
      handlerVideoStatus(s, '1')
  	}
    // 监听视频流
    function videoHandler2(s){
      handlerVideoStatus(s, '2')
  	}
    // 监听视频流
    function videoHandler3(s){
      handlerVideoStatus(s, '3')
  	}
    // 监听视频流
    function videoHandler4(s){
      handlerVideoStatus(s, '4')
  	}
    // 解析视频流
    function handlerVideoStatus(s, id) {
      var $loading = $('#loading' + id),$info = $('#info' + id)
      var ckpayerId = !id? 'maxVideo' : ('minVideo' + id)
      switch (s) {
        case 'NetConnection.Connect.Success':
          $info.html('网络连接中<img src="static/loading.gif" />')
          break;
        case 'NetStream.Play.Start':
          $info.html('网络连接成功<img src="static/loading.gif" />')
          break;
        case 'NetStream.Unpause.Notify':
          $info.html('视频加载中<img src="static/loading.gif" />')
          break;
        case 'NetStream.Buffer.Full':
          $loading.hide()
          if (bitrate && !bitrateTask) {
            bitrateTask = setInterval(function () {
              var maxVideoPlayer = CKobject.getObjectById('ckplayer_maxVideo'),
              ckplayer_minVideoPlayer1 = CKobject.getObjectById('ckplayer_minVideo1'),
              ckplayer_minVideoPlayer2 = CKobject.getObjectById('ckplayer_minVideo2'),
              ckplayer_minVideoPlayer3 = CKobject.getObjectById('ckplayer_minVideo3'),
              ckplayer_minVideoPlayer4 = CKobject.getObjectById('ckplayer_minVideo4')
              var current = maxVideoPlayer.getStatus().speed * 2/100000,
              current1 = ckplayer_minVideoPlayer1 ? ckplayer_minVideoPlayer1.getStatus().speed * 2/100000 : 'Error',
              current2 = ckplayer_minVideoPlayer2 ? ckplayer_minVideoPlayer2.getStatus().speed * 2/100000 : 'Error',
              current3 = ckplayer_minVideoPlayer3 ? ckplayer_minVideoPlayer3.getStatus().speed * 2/100000 : 'Error',
              current4 = ckplayer_minVideoPlayer4 ? ckplayer_minVideoPlayer4.getStatus().speed * 2/100000 : 'Error'
              current = isNaN(current) ? '' : (Math.round(parseFloat(current)*100)/100 + 'mbps')
              $('#bitrate').text(current)
              current1 = isNaN(current1) ? '' : (Math.round(parseFloat(current1)*100)/100 + 'mbps')
              $('#bitrate1').text(current1)
              current2 = isNaN(current2) ? '' : (Math.round(parseFloat(current2)*100)/100 + 'mbps')
              $('#bitrate2').text(current2)
              current3 = isNaN(current3) ? '' : (Math.round(parseFloat(current3)*100)/100 + 'mbps')
              $('#bitrate3').text(current3)
              current4 = isNaN(current4) ? '' : (Math.round(parseFloat(current4)*100)/100 + 'mbps')
              $('#bitrate4').text(current4)
            }, 1000)
          }
          break;
        case 'NetStream.Play.StreamNotFound':
          $info.text('视频连接失败')
          setTimeout(function(){
            CKobject.getObjectById('ckplayer_' + ckpayerId).removeListener('netStatus','videoHandler' + id)
          },250)
          break;
      }
    }
    // 全屏
    function fullScreen(e) {
      if ($(e).hasClass('icon-quanping')) {
        CKobject.getObjectById('ckplayer_maxVideo').videoWAndH(100/0.75, 100)
        var originalWidth = $('#maxVideo').width()
        $(e).removeClass('icon-quanping').addClass('icon-quxiaoquanping')
        $('.main').attr('style', 'width:100%')
        $('.other').hide()
      } else {
        CKobject.getObjectById('ckplayer_maxVideo').videoWAndH(100, 100)
        $(e).removeClass('icon-quxiaoquanping').addClass('icon-quanping')
        $('.main').attr('style', 'width:75%')
        $('.other').show()
      }
    }
  </script>
</body>

</html>
